# 封装和扩展现有pallet


本节我们讲解在pallet中使用其它palllet的另外一种情况，即在新的pallet中封装和扩展现有的pallet。我们这里substrate提供的contracts pallet，然后对其中的功能进行封装。在我们的封装中，将contracts pallet的call函数封装成sudo_call，即需要root权限才能调用。同时，我们在runtime中加载contracts时，去掉直接调用contracts函数的方式。

整个方式我们分成两大步骤，如下：

* 编写extend-pallet;
* 在runtime配置extend-pallet和contracts pallet。

# 1 编写extend-pallet
首先我们编写封装contracts pallet的pallet，取名叫做extend-pallet，主要代码如下：
```
#![cfg_attr(not(feature = "std"), no_std)]

use codec::{Encode, HasCompact};
use frame_support::traits::Currency;
use scale_info::TypeInfo;
use sp_core::crypto::UncheckedFrom;
use sp_runtime::traits::StaticLookup;
use sp_std::{fmt::Debug, prelude::*};

type BalanceOf<T> = <<T as pallet_contracts::Config>::Currency as Currency<
	<T as frame_system::Config>::AccountId,
>>::Balance;

pub use pallet::*;

#[frame_support::pallet]
pub mod pallet {
	use super::*;
	use frame_support::pallet_prelude::*;
	use frame_system::pallet_prelude::*;

	#[pallet::pallet]
	#[pallet::generate_store(pub(super) trait Store)]
	pub struct Pallet<T>(_);

  // 重点关注1
	#[pallet::config]
	pub trait Config: pallet_contracts::Config + frame_system::Config {}
  
  // 重点关注2
	#[pallet::call]
	impl<T: Config> Pallet<T>
	where
		T::AccountId: UncheckedFrom<T::Hash>,
		T::AccountId: AsRef<[u8]>,
		<BalanceOf<T> as HasCompact>::Type: Clone + Eq + PartialEq + Debug + TypeInfo + Encode,
	{
		#[pallet::weight(0)]
		pub fn sudo_call(
			origin: OriginFor<T>,
			dest: <T::Lookup as StaticLookup>::Source,
			#[pallet::compact] value: BalanceOf<T>,
			#[pallet::compact] gas_limit: Weight,
			storage_deposit_limit: Option<<BalanceOf<T> as codec::HasCompact>::Type>,
			data: Vec<u8>,
		) -> DispatchResultWithPostInfo {
      //添加下面这行，用于判断是否是root权限
			ensure_root(origin.clone())?;

      //直接调用pallet-contracts的call函数
			pallet_contracts::Pallet::<T>::call(
				origin,
				dest,
				value,
				gas_limit,
				storage_deposit_limit,
				data,
			)
		}
	}
}
```
在上面的pallet中，主要有两个部分需要重点关注，一个是Config部分，封装pallet的Config需要集成被封装pallet的Config，如下：
```
  // 重点关注1
	#[pallet::config]
	pub trait Config: pallet_contracts::Config + frame_system::Config {}
```

另外一个是上面的“重点关注2”部分，对主要pallet-contracts的call函数进行封装，在这部分里面，我们添加判断root权限的语句，然后直接调用pallet-contracts的call函数。

# 2 在runtime中配置pallet

# 3 测试


# 4 参考文档

https://www.shawntabrizi.com/substrate/extending-substrate-runtime-modules/

# 5 完整源码地址
