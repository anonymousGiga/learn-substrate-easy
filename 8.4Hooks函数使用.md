# 钩子函数的使用

# 1 背景知识
## 1.1 交易到打包的过程
在这个教程中，我其实一直回避原理性的知识，因为感觉讲太多原理性的东西会让入门变得更难。但是当准备讲hooks的时候，发现必须得讲讲区块链打包记账的过程，否则就不好理解。所以这里画了一张区块链运行的示意图，如下：

![发起交易到打包的过程](./assets/运行图.PNG)


图中描述了交易产生到打包成到区块中，最后每个节点接受区块存储到本地的全过程，这里我们简单描述下过程：
```
1、用户通过钱包发起交易;
2、和钱包相连的全节点收到交易后会把交易广播到网络中;
3、然后根据共识算法打包区块，某个全节点获得了打包权（图中画的是节点4），然后将交易打包到区块中;
4、打包好区块后，将区块广播到网络中;
5、其它每个节点收到区块后验证，然后执行区块里面的交易，更新自己本地的账本。
```


## 1.2 substrate中的执行过程
上面我们讲了区块链系统的打包的过程，下面我们再讲讲substrate中具体的区块执行的过程（上面的第5步）。在substrate中区块执行主要分为三步，分别是：
* 初始化区块（Initializes the block）;
* 执行区块（Executes extrinsics）;
* 确认区块（Finalizes the block）.

### 1.2.1 初始化区块
初始化区块时就会执行所有pallet（就是construct_runtime!中包含的pallet）的on_initialize函数，不过会最先执行System模块的（frame-system）.

### 1.2.2 执行交易

### 1.2.3 确认区块
  
# 2 hooks介绍 
```
pub trait Hooks<BlockNumber> {
    fn on_finalize(_n: BlockNumber) { ... }
    fn on_idle(_n: BlockNumber, _remaining_weight: Weight) -> Weight { ... }
    fn on_initialize(_n: BlockNumber) -> Weight { ... }
    fn on_runtime_upgrade() -> Weight { ... }
    fn pre_upgrade() -> Result<(), &'static str> { ... }
    fn post_upgrade() -> Result<(), &'static str> { ... }
    fn offchain_worker(_n: BlockNumber) { ... }
    fn integrity_test() { ... }
}
```
每个钩子函数在对应的时间自动调用执行，开发者可以根据需要在这些钩子函数中添加业务逻辑。

# 3 示例

# 4 参考文档

# 5 完整源码
